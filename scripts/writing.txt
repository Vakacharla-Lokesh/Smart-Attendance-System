#include <SPI.h>
#include <MFRC522.h>

#define RST_PIN D3  // Reset pin
#define SS_PIN D4   // SDA/SS pin

MFRC522 mfrc522(SS_PIN, RST_PIN);  
MFRC522::MIFARE_Key key;

const int blockNum = 4;  // Data will be stored in block 4
char name[] = "John Doe"; // Name to write (max 16 chars)

void setup() {
    Serial.begin(9600);
    SPI.begin();       
    mfrc522.PCD_Init();  
    Serial.println("Scan your RFID card to write data...");
    
    // Set default authentication key (most cards use this)
    for (byte i = 0; i < 6; i++) key.keyByte[i] = 0xFF;
}

void loop() {
    if (!mfrc522.PICC_IsNewCardPresent() || !mfrc522.PICC_ReadCardSerial()) return;

    Serial.println("\nCard detected! Writing name...");
    
    // Authenticate before writing
    MFRC522::StatusCode status = mfrc522.PCD_Authenticate(
        MFRC522::PICC_CMD_MF_AUTH_KEY_A, blockNum, &key, &(mfrc522.uid));

    if (status != MFRC522::STATUS_OK) {
        Serial.print("Authentication failed: ");
        Serial.println(mfrc522.GetStatusCodeName(status));
        return;
    }

    // Convert name to 16-byte array
    byte buffer[16] = {0};  
    strncpy((char *)buffer, name, 16);

    // Write data to the card
    status = mfrc522.MIFARE_Write(blockNum, buffer, 16);
    
    if (status == MFRC522::STATUS_OK) {
        Serial.println("âœ… Name written successfully!");
    } else {
        Serial.print("âŒ Write failed: ");
        Serial.println(mfrc522.GetStatusCodeName(status));
    }

    delay(1000);  // Small delay before reading back data
    Serial.println("\nðŸ”„ Reading stored data...");
    readRFIDData();
}

void readRFIDData() {
    byte buffer[18];
    byte bufferSize = sizeof(buffer);

    // Authenticate before reading
    MFRC522::StatusCode status = mfrc522.PCD_Authenticate(
        MFRC522::PICC_CMD_MF_AUTH_KEY_A, blockNum, &key, &(mfrc522.uid));

    if (status != MFRC522::STATUS_OK) {
        Serial.print("Authentication failed: ");
        Serial.println(mfrc522.GetStatusCodeName(status));
        return;
    }

    // Read data from the card
    status = mfrc522.MIFARE_Read(blockNum, buffer, &bufferSize);
    
    if (status == MFRC522::STATUS_OK) {
        Serial.print("ðŸ“– Stored Name: ");
        Serial.println((char*)buffer);  // Convert byte array to string
    } else {
        Serial.print("âŒ Read failed: ");
        Serial.println(mfrc522.GetStatusCodeName(status));
    }

    mfrc522.PICC_HaltA();          // Halt card
    mfrc522.PCD_StopCrypto1();     // Stop encryption
}
